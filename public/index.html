<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Realtime Canvas</title>
<style>
  html,body{margin:0;height:100%;background:#ffffff;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:740px;margin:20px auto;padding:16px;border:1px solid #e5e5e5;border-radius:12px;background:#fafafa}
  input,button{background:#fff;color:#111;border:1px solid #d0d0d0;border-radius:10px;padding:10px 12px;font-size:16px}
  button{cursor:pointer} button:active{transform:translateY(1px)}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:.5rem 0}
  #rooms{display:grid;gap:8px;margin-top:8px}
  #cvs{display:none;position:fixed;inset:0;touch-action:none;background:#ffffff}
  #toolbar{position:fixed;left:8px;top:8px;display:none;gap:8px;background:#ffffffcc;border:1px solid #d0d0d0;border-radius:12px;padding:8px;backdrop-filter:blur(6px)}
  label{font-size:12px;opacity:.85}
  .hint{position:fixed;right:8px;bottom:8px;background:#ffffffcc;border:1px solid #d0d0d0;border-radius:10px;padding:6px 8px;font-size:12px}
</style>

<div id="lobby" class="wrap">
  <h2>–ö–æ–º–Ω–∞—Ç—ã</h2>
  <div class="row">
    <input id="room" placeholder="id –∫–æ–º–Ω–∞—Ç—ã" style="flex:1">
    <button id="create">–°–æ–∑–¥–∞—Ç—å</button>
    <button id="join">–í–æ–π—Ç–∏</button>
  </div>
  <div class="row"><button id="refresh">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button></div>
  <div id="rooms"></div>
</div>

<canvas id="cvs"></canvas>
<div id="toolbar">
  <button id="draw">‚úèÔ∏è</button>
  <button id="erase">ü©π</button>
  <input id="color" type="color" value="#000000" title="—Ü–≤–µ—Ç">
  <input id="size" type="range" min="1" max="40" value="6" title="—Ç–æ–ª—â–∏–Ω–∞">
  <button id="move">üñêÔ∏è</button>
</div>
<div class="hint">–ö–æ–ª—ë—Å–∏–∫–æ: –∑—É–º ‚Ä¢ Shift+–∫–æ–ª—ë—Å–∏–∫–æ: –ø–∞–Ω–æ—Ä–∞–º–∞ ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –∫–Ω–æ–ø–∫–∞: –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ</div>

<script src="net-webrtc.js"></script>
<script>
const lobby = document.getElementById('lobby');
const roomsEl = document.getElementById('rooms');
const cvs = document.getElementById('cvs'), ctx = cvs.getContext('2d');
const toolbar = document.getElementById('toolbar');
let DPR = Math.max(1, devicePixelRatio||1), camera={x:0,y:0,scale:1};

let mode='draw', brush={color:'#000000', size:6};
document.getElementById('draw').onclick=()=>mode='draw';
document.getElementById('erase').onclick=()=>mode='erase';
document.getElementById('move').onclick=()=>mode='move';
document.getElementById('color').oninput=e=>brush.color=e.target.value;
document.getElementById('size').oninput=e=>brush.size=+e.target.value;

let roomId=null, meId=null, coordinator=false, hasSynced=false;

// —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç
async function renderRooms(){
  const list = await Net.rooms().catch(()=>[]);
  roomsEl.innerHTML='';
  list.forEach(r=>{
    const b=document.createElement('button');
    b.textContent=`${r.id} (${r.users})`;
    b.onclick=()=> document.getElementById('room').value=r.id;
    roomsEl.appendChild(b);
  });
}
document.getElementById('refresh').onclick=renderRooms; renderRooms();
document.getElementById('create').onclick = ()=> {
  const rid = (document.getElementById('room').value.trim() || `room-${Math.random().toString(36).slice(2,6)}`);
  document.getElementById('room').value = rid;
};
document.getElementById('join').onclick = ()=>{
  roomId = document.getElementById('room').value.trim() || 'public-room';
  Net.connect(roomId,{
    onJoined: ({me, peers})=>{
      meId = me;
      coordinator = peers.every(pid => String(me) < String(pid)); // —Å–∞–º—ã–π "–º–∞–ª–µ–Ω—å–∫–∏–π" id ‚Äî –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä
      Net.requestState(); // –ø–æ–ø—Ä–æ—Å–∏–º —Å–µ—Ä–≤–µ—Ä–Ω—É—é –∫–æ–ø–∏—é, –µ—Å–ª–∏ –µ—Å—Ç—å
      // –µ—Å–ª–∏ –Ω–∏ –æ—Ç –∫–æ–≥–æ –Ω–µ –ø—Ä–∏–¥—ë—Ç state_full –∑–∞ 1—Å ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
      setTimeout(()=>{ if (!hasSynced) loadLocal(); }, 1000);
    },
    onPeerOpen: (peerId)=>{
      // –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª ‚Äî –ø–æ–ø—Ä–æ—Å–∏–º —É –Ω–µ–≥–æ —Å–Ω–∞–ø—à–æ—Ç (–∞–¥—Ä–µ—Å–Ω–æ)
      Net.sendReliableTo(peerId, { type:'state_req' });
    },
    onState: (state)=>{
      if (state && Array.isArray(state.strokes)) { strokes = state.strokes; hasSynced=true; requestRender(); }
    },
    onMsg: (msg)=> handleMsg(msg),
    onCursor: ({id,x,y,drawing})=> { cursors.set(id,{x,y,drawing,ts:Date.now()}); requestRender(); }
  });
  lobby.style.display='none'; cvs.style.display='block'; toolbar.style.display='flex';
  resize();
};

// ====== —Ä–∏—Å–æ–≤–∞–ª–∫–∞ ======
let strokes=[], cursors=new Map();
function resize(){ const w=innerWidth,h=innerHeight; DPR=Math.max(1,devicePixelRatio||1);
  cvs.width=w*DPR; cvs.height=h*DPR; cvs.style.width=w+'px'; cvs.style.height=h+'px'; ctx.setTransform(DPR,0,0,DPR,0,0); requestRender(); }
addEventListener('resize', resize,{passive:true});

// –ó—É–º –∫–æ–ª—ë—Å–∏–∫–æ–º (–ø–æ –∫—É—Ä—Å–æ—Ä—É) + –ø–∞–Ω–æ—Ä–∞–º–∞ (Shift+–∫–æ–ª—ë—Å–∏–∫–æ)
cvs.addEventListener('wheel', (e)=>{
  e.preventDefault();
  const mouse = { clientX: e.clientX, clientY: e.clientY };
  if (e.shiftKey){
    camera.x -= e.deltaX / camera.scale;
    camera.y -= e.deltaY / camera.scale;
  } else {
    const before = toWorld(mouse);
    const k = Math.pow(1.0015, -e.deltaY); // –ø–ª–∞–≤–Ω—ã–π
    const newScale = clamp(camera.scale * k, 0.1, 8);
    camera.scale = newScale;
    const after = toWorld(mouse);
    camera.x += before.x - after.x;
    camera.y += before.y - after.y;
  }
  requestRender();
},{passive:false});

function toWorld(e){ return { x: e.clientX/camera.scale + camera.x, y: e.clientY/camera.scale + camera.y }; }
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
let rerender=false; function requestRender(){ rerender=true; }
function loop(){ if (rerender){ draw(); rerender=false; } requestAnimationFrame(loop); } loop();

function draw(){
  const w=cvs.width/DPR, h=cvs.height/DPR;
  // —Ñ–æ–Ω –±–µ–ª—ã–π
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,w,h);

  // —à—Ç—Ä–∏—Ö–∏ (–ª–∞—Å—Ç–∏–∫ ‚Äî destination-out)
  for(const s of strokes){
    ctx.save();
    ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.globalCompositeOperation = (s.mode==='erase')?'destination-out':'source-over';
    ctx.strokeStyle=s.color; ctx.lineWidth=s.size*camera.scale;
    ctx.beginPath();
    s.points.forEach((p,i)=>{const x=(p.x-camera.x)*camera.scale, y=(p.y-camera.y)*camera.scale; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);});
    ctx.stroke(); ctx.restore();
  }

  // —Å–µ—Ç–∫–∞ –°–í–ï–†–•–£ (—Ç–µ–ø–µ—Ä—å –ª–∞—Å—Ç–∏–∫ –µ—ë –Ω–µ "—Å—ä–µ–¥–∞–µ—Ç")
  const step = 200*camera.scale;
  if (step>24){ ctx.strokeStyle='#e6e6e6'; ctx.lineWidth=1;
    const sx = -((camera.x*camera.scale)%step), sy = -((camera.y*camera.scale)%step);
    ctx.beginPath(); for(let x=sx;x<w;x+=step){ ctx.moveTo(x,0); ctx.lineTo(x,h); }
    for(let y=sy;y<h;y+=step){ ctx.moveTo(0,y); ctx.lineTo(w,y); } ctx.stroke();
  }

  // –∫—É—Ä—Å–æ—Ä—ã
  const now=Date.now();
  for(const [id,c] of cursors){
    if(now-c.ts>3000) continue;
    const x=(c.x-camera.x)*camera.scale, y=(c.y-camera.y)*camera.scale;
    ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fillStyle='#007aff'; ctx.fill();
  }
}

let isDown=false, lastMove=null, current=null;
const buffer = []; // –±–∞—Ç—á–∏–º —Å–µ—Ç–µ–≤—ã–µ —Ç–æ—á–∫–∏
let flushTimer=null;

cvs.addEventListener('pointerdown', (e)=>{ cvs.setPointerCapture(e.pointerId); isDown=true;
  if (e.button===1 || mode==='move'){ lastMove = {x:e.clientX,y:e.clientY}; return; }
  const w=toWorld(e);
  current = { id:`${Date.now()}-${Math.random().toString(36).slice(2,6)}`, mode, color:(mode==='erase'?'#000000':brush.color), size:brush.size, points:[w] };
  strokes.push(current); debounceSave();
  enqueue({ type:'stroke_pts', id: current.id, mode: current.mode, color: current.color, size: current.size, points:[w] });
  requestRender();
});
cvs.addEventListener('pointermove', (e)=>{
  const w=toWorld(e);
  if (e.buttons===4 || (isDown && (e.button===1 || mode==='move'))){ // —Å—Ä–µ–¥–Ω—è—è –∫–Ω–æ–ø–∫–∞/—Ä–µ–∂–∏–º move
    if (lastMove){ camera.x -= (e.clientX-lastMove.x)/camera.scale; camera.y -= (e.clientY-lastMove.y)/camera.scale; requestRender(); }
    lastMove = {x:e.clientX, y:e.clientY}; return;
  }
  if(isDown && current){ current.points.push(w); enqueue({ type:'stroke_pts', id: current.id, mode: current.mode, color: current.color, size: current.size, points:[w] }); requestRender(); }
  Net.sendCursor({ x:w.x, y:w.y, drawing:isDown });
});
cvs.addEventListener('pointerup', ()=>{ isDown=false; lastMove=null; current=null; });

function enqueue(op){
  buffer.push(op);
  if(!flushTimer){
    flushTimer = setTimeout(()=>{
      Net.sendReliable({ type:'batch', ops: buffer.splice(0, buffer.length) });
      flushTimer=null;
    }, 20);
  }
}

function handleMsg(msg){
  const op = msg; // —É–∂–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–æ
  if(op.type==='batch'){ for(const a of op.ops) handleMsg(a); return; }
  if(op.type==='stroke_pts'){
    let s = strokes.find(x=>x.id===op.id);
    if(!s){ s={ id:op.id, mode:op.mode, color:op.color, size:op.size, points:[] }; strokes.push(s); }
    for(const p of op.points) s.points.push(p);
    debounceSave(); requestRender(); return;
  }
  if(op.type==='state_req'){
    // –∞–¥—Ä–µ—Å–Ω–æ –æ—Ç–≤–µ—Ç–∏–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–∏–≤—à–µ–º—É
    Net.sendReliableTo(msg.id, { type:'state_full', strokes });
    return;
  }
  if(op.type==='state_full'){
    strokes = op.strokes || []; hasSynced = true; requestRender(); debounceSave();
    return;
  }
}

// === –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è ===
function saveLocal(){ try{ localStorage.setItem('room:'+roomId, JSON.stringify({strokes})); }catch{} }
function loadLocal(){ try{ const j=localStorage.getItem('room:'+roomId); if(j){ const s=JSON.parse(j); if(Array.isArray(s.strokes)){ strokes=s.strokes; hasSynced=true; requestRender(); } } }catch{} }
let saveTimer=null;
function debounceSave(){
  if (saveTimer) return;
  saveTimer = setTimeout(()=>{
    saveTimer=null;
    saveLocal();
    // –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É—é—â–∏–π –∫–ª–∏–µ–Ω—Ç —à–ª—ë—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–ø–∞–º—è—Ç—å –Ω–∞ —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–µ)
    if (coordinator) Net.saveState({ strokes });
  }, 300);
}
</script>
